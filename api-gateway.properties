# Server Configuration
spring.config.import=optional:configserver:http://config-server:8888

server.port=8080
spring.application.name=api-gateway

# MongoDB Configuration for Users (Docker Mongo host)
spring.data.mongodb.uri=mongodb://mongodb:27017/auth_db
spring.data.mongodb.auto-index-creation=true

# JWT Configuration
jwt.secret=15fb8f47f5e37937b48b1ba19c6e4d0c4ec1ac033b8b988169effd82a8cb617d
jwt.expiration=86400000
jwt.cookie.name=authToken
jwt.cookie.max-age=86400

# Eureka Configuration (Docker Eureka host)
eureka.client.serviceUrl.defaultZone=http://eureka-server:8761/eureka/
eureka.client.register-with-eureka=true
eureka.client.fetch-registry=true
eureka.instance.prefer-ip-address=false
eureka.instance.hostname=api-gateway

spring.cloud.gateway.routes[0].id=auth-service
spring.cloud.gateway.routes[0].uri=http://auth-service:8080
spring.cloud.gateway.routes[0].predicates[0]=Path=/auth/**

spring.cloud.gateway.default-filters[0]=AuthenticationFilter

# 1. Get all airlines (READ - requires auth)
spring.cloud.gateway.routes[1].id=flights-get-airlines
spring.cloud.gateway.routes[1].uri=lb://flights-service
spring.cloud.gateway.routes[1].predicates[0]=Path=/airline
spring.cloud.gateway.routes[1].predicates[1]=Method=GET
spring.cloud.gateway.routes[1].filters[0]=AuthenticationFilter

# 2. Get airline by ID (READ - requires auth)
spring.cloud.gateway.routes[2].id=flights-get-airline-by-id
spring.cloud.gateway.routes[2].uri=lb://flights-service
spring.cloud.gateway.routes[2].predicates[0]=Path=/airline/{id}
spring.cloud.gateway.routes[2].predicates[1]=Method=GET
spring.cloud.gateway.routes[2].filters[0]=AuthenticationFilter

# 3. Create airline (WRITE - requires auth)
spring.cloud.gateway.routes[3].id=flights-create-airline
spring.cloud.gateway.routes[3].uri=lb://flights-service
spring.cloud.gateway.routes[3].predicates[0]=Path=/airline
spring.cloud.gateway.routes[3].predicates[1]=Method=POST
spring.cloud.gateway.routes[3].filters[0]=AuthenticationFilter

# 4. Update airline (WRITE - requires auth)
spring.cloud.gateway.routes[4].id=flights-update-airline
spring.cloud.gateway.routes[4].uri=lb://flights-service
spring.cloud.gateway.routes[4].predicates[0]=Path=/airline/{id}
spring.cloud.gateway.routes[4].predicates[1]=Method=PUT
spring.cloud.gateway.routes[4].filters[0]=AuthenticationFilter

# 5. Delete airline (WRITE - requires auth)
spring.cloud.gateway.routes[5].id=flights-delete-airline
spring.cloud.gateway.routes[5].uri=lb://flights-service
spring.cloud.gateway.routes[5].predicates[0]=Path=/airline/{id}
spring.cloud.gateway.routes[5].predicates[1]=Method=DELETE
spring.cloud.gateway.routes[5].filters[0]=AuthenticationFilter

# 6. Add flight to inventory (WRITE - requires auth)
spring.cloud.gateway.routes[6].id=flights-add-flight
spring.cloud.gateway.routes[6].uri=lb://flights-service
spring.cloud.gateway.routes[6].predicates[0]=Path=/flight/airline/inventory
spring.cloud.gateway.routes[6].predicates[1]=Method=POST
spring.cloud.gateway.routes[6].filters[0]=AuthenticationFilter

# 7. Search flights (READ - requires auth)
spring.cloud.gateway.routes[7].id=flights-search
spring.cloud.gateway.routes[7].uri=lb://flights-service
spring.cloud.gateway.routes[7].predicates[0]=Path=/flight/search
spring.cloud.gateway.routes[7].predicates[1]=Method=POST
spring.cloud.gateway.routes[7].filters[0]=AuthenticationFilter

# 8. Get flight by ID (READ - requires auth)
spring.cloud.gateway.routes[8].id=flights-get-flight
spring.cloud.gateway.routes[8].uri=lb://flights-service
spring.cloud.gateway.routes[8].predicates[0]=Path=/flight/{id}
spring.cloud.gateway.routes[8].predicates[1]=Method=GET
spring.cloud.gateway.routes[8].filters[0]=AuthenticationFilter

# 9. Update flight seats (WRITE - requires auth)
spring.cloud.gateway.routes[9].id=flights-update-seats
spring.cloud.gateway.routes[9].uri=lb://flights-service
spring.cloud.gateway.routes[9].predicates[0]=Path=/flight/{id}/seats
spring.cloud.gateway.routes[9].predicates[1]=Method=PUT
spring.cloud.gateway.routes[9].filters[0]=AuthenticationFilter

# 10. Delete flight (WRITE - requires auth)
spring.cloud.gateway.routes[10].id=flights-delete-flight
spring.cloud.gateway.routes[10].uri=lb://flights-service
spring.cloud.gateway.routes[10].predicates[0]=Path=/flight/{id}
spring.cloud.gateway.routes[10].predicates[1]=Method=DELETE
spring.cloud.gateway.routes[10].filters[0]=AuthenticationFilter

# 1. Create booking (WRITE - requires auth)
spring.cloud.gateway.routes[11].id=bookings-create
spring.cloud.gateway.routes[11].uri=lb://bookings-service
spring.cloud.gateway.routes[11].predicates[0]=Path=/flight/booking/{flightId}
spring.cloud.gateway.routes[11].predicates[1]=Method=POST
spring.cloud.gateway.routes[11].filters[0]=AuthenticationFilter

# 2. Get ticket by PNR (READ - requires auth)
spring.cloud.gateway.routes[12].id=bookings-get-ticket
spring.cloud.gateway.routes[12].uri=lb://bookings-service
spring.cloud.gateway.routes[12].predicates[0]=Path=/flight/ticket/{pnr}
spring.cloud.gateway.routes[12].predicates[1]=Method=GET
spring.cloud.gateway.routes[12].filters[0]=AuthenticationFilter

# 3. Get booking history (READ - requires auth)
spring.cloud.gateway.routes[13].id=bookings-history
spring.cloud.gateway.routes[13].uri=lb://bookings-service
spring.cloud.gateway.routes[13].predicates[0]=Path=/flight/booking/history/{emailId}
spring.cloud.gateway.routes[13].predicates[1]=Method=GET
spring.cloud.gateway.routes[13].filters[0]=AuthenticationFilter

# 4. Cancel booking (WRITE - requires auth)
spring.cloud.gateway.routes[14].id=bookings-cancel
spring.cloud.gateway.routes[14].uri=lb://bookings-service
spring.cloud.gateway.routes[14].predicates[0]=Path=/flight/booking/cancel/{pnr}
spring.cloud.gateway.routes[14].predicates[1]=Method=DELETE
spring.cloud.gateway.routes[14].filters[0]=AuthenticationFilter

# 11. Release seats on flight (WRITE - internal / requires auth)
spring.cloud.gateway.routes[15].id=flights-release-seats
spring.cloud.gateway.routes[15].uri=lb://flights-service
spring.cloud.gateway.routes[15].predicates[0]=Path=/flight/{id}/release-seats
spring.cloud.gateway.routes[15].predicates[1]=Method=PUT
spring.cloud.gateway.routes[15].filters[0]=AuthenticationFilter

# Gateway Discovery
spring.cloud.gateway.discovery.locator.enabled=true
spring.cloud.gateway.discovery.locator.lower-case-service-id=true

# Circuit Breaker - Flights Service
resilience4j.circuitbreaker.instances.flights-service.slidingWindowSize=10
resilience4j.circuitbreaker.instances.flights-service.failureRateThreshold=50
resilience4j.circuitbreaker.instances.flights-service.waitDurationInOpenState=10000
resilience4j.circuitbreaker.instances.flights-service.permittedNumberOfCallsInHalfOpenState=3

# Circuit Breaker - Bookings Service
resilience4j.circuitbreaker.instances.bookings-service.slidingWindowSize=10
resilience4j.circuitbreaker.instances.bookings-service.failureRateThreshold=50
resilience4j.circuitbreaker.instances.bookings-service.waitDurationInOpenState=10000
resilience4j.circuitbreaker.instances.bookings-service.permittedNumberOfCallsInHalfOpenState=3

# Management Endpoints
management.endpoints.web.exposure.include=*
management.endpoint.health.show-details=always

# Logging
logging.level.org.springframework.cloud.gateway=DEBUG
logging.level.org.springframework.cloud.gateway.route=DEBUG
logging.level.reactor.netty=DEBUG
logging.level.com.flightapp=DEBUG

# CORS Configuration for Spring Cloud Gateway
spring.cloud.gateway.globalcors.corsConfigurations.[/**].allowedOrigins=http://localhost:4200
spring.cloud.gateway.globalcors.corsConfigurations.[/**].allowedMethods=GET,POST,PUT,DELETE,OPTIONS
spring.cloud.gateway.globalcors.corsConfigurations.[/**].allowedHeaders=*
spring.cloud.gateway.globalcors.corsConfigurations.[/**].allowCredentials=true
spring.cloud.gateway.globalcors.add-to-simple-url-handler-mapping=true
